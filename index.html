<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta charset="utf-8"/>
</head>
<body>
    <div id="mapdiv"></div>
    <div id="x"></div>
    <script src="http://www.openlayers.org/api/OpenLayers.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script>

        $.getJSON('/api/data', function(data) {
            console.log(data[0].longitude);
            console.log(data[0].latitude);
            console.log(data[0].h);
            console.log(data[0].p);
            console.log(data[0].obs)
            console.log(data[0].typ)
            
            
            
            var veri1=data[0].longitude;
            var veri2=data[0].latitude;
            

            map = new OpenLayers.Map("mapdiv");
    map.addLayer(new OpenLayers.Layer.OSM());
    
    epsg4326 =  new OpenLayers.Projection("EPSG:4326"); //WGS 1984 projection
    projectTo = map.getProjectionObject(); //The map projection (Spherical Mercator)
   
    

            var point;
            var length=data.length;

            var vectorLayer = new OpenLayers.Layer.Vector("Overlay");
            //TODO - data haritaya ekleme işlemi
            for (point = 0; point < data.length; point++) {
            var lon=data[point].longitude;
            var lat=data[point].latitude;
            var he=data[point].h;
            var pht=data[point].p;
            var observation = data[point].obs
            var tree_type = data[point].typ

            

            var lonLat = new OpenLayers.LonLat(lon,lat ).transform(new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
                                                                map.getProjectionObject() // to Spherical Mercator Projection
                                                                )
            var zoom=8;
        
            var markers = new OpenLayers.Layer.Markers( "Markers" );
            map.addLayer(markers)
                
            markers.addMarker(new OpenLayers.Marker(lonLat))
                
            map.setCenter (lonLat, zoom)

            // Define markers as "features" of the vector layer: 
    var feature = new OpenLayers.Feature.Vector(
            new OpenLayers.Geometry.Point( lon,lat ).transform(epsg4326, projectTo),
            {description:'Latitude: '+lat+'<br>Longitude: '+lon+'<br>Height:'+he+'<br>'+'<br>İmage<br>'+'<img src="http://pngimg.com/uploads/tree/tree_PNG92789.png"  height="100" width="100">'+'<br>'+'<br>Resim Yolu: '
            +pht+'<br>Observation time:'+observation+'<br>Tree Type:'+tree_type} ,
            
            {externalGraphic: 'img/marker.png', graphicHeight: 25, graphicWidth: 21, graphicXOffset:-12, graphicYOffset:-25  }
        );
          
    vectorLayer.addFeatures(feature);
    
       
    

   
    map.addLayer(vectorLayer);
 
    
    //Add a selector control to the vectorLayer with popup functions
    var controls = {
      selector: new OpenLayers.Control.SelectFeature(vectorLayer, { onSelect: createPopup, onUnselect: destroyPopup })
    };

    function createPopup(feature) {
      feature.popup = new OpenLayers.Popup.FramedCloud("pop",
          feature.geometry.getBounds().getCenterLonLat(),
          null,
          '<div class="markerContent">'+feature.attributes.description+'</div>',
          null,
          true,
          function() { controls['selector'].unselectAll(); }
      );
      //feature.popup.closeOnMove = true;
      map.addPopup(feature.popup);
    }

    function destroyPopup(feature) {
      feature.popup.destroy();
      feature.popup = null;
    }
    
    map.addControl(controls['selector']);
    controls['selector'].activate();
            
            }


        });
    </script>
  </body>
  </html>
